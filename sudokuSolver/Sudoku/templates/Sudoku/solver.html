<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sudoku</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'Sudoku/css/solver.css' %}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Caveat+Brush&family=Karla:ital,wght@0,200..800;1,200..800&display=swap"
        rel="stylesheet">
</head>

<body>
    {% csrf_token %}
    <div class="ham">
        <button id = "ham" class="ham"><img id="ham" src="{% static 'Sudoku/images/ham1.png' %}" alt="" srcset=""></button>
    </div>
    <div class ="sidebar" id = "sidebar">
    <nav>
        <div class="top">

            <div class="menu">
                <div class="hamburger">
                    <img id="hamburger" src="{% static 'Sudoku/images/menu.svg' %}" alt="" srcset="">
                </div>
                <div class="homeicon">
                    <a href="{% url 'home' %}">
                    <img id="homeicon" src="{% static 'Sudoku/images/home.svg' %}" alt="" srcset="">
                </a>
                </div>
            </div>
            <div class="Play" id="playbutton" onclick="navigateToPlay()">  
                <img src="{% static 'Sudoku/images/joy.svg' %}" alt="" srcset="">  
                <p>Play</p>  
            </div>  
            
            <div class="Play" id="solverbutton" onclick="navigateToSolver()">  
                <img src="{% static 'Sudoku/images/cube.svg' %}" alt="" srcset="">  
                <p>Solver</p>  
            </div>  
            
            {% if user.is_authenticated %}
            <script>  
            function navigateToPlay() {  
                window.location.href = "{% url 'play' %}";
            }
            </script>
            {% else %}
            <script>  
            function navigateToPlay() {  
                    window.location.href = "{% url 'login' %}";
            }
            </script>
            {% endif %}

            

            </div>

            <div class="buttom">
                <div class="help">
                    <img src="{% static 'Sudoku/images/questionmark.svg' %}" alt="">
                    <p>Help</p>
                </div>
            </div>
    </nav>
</div>


{% if user.is_authenticated %}
        <div class="user-profile" id="userProfile">
            <div class="profile-header">
                <div class="profile-icon">
                    <img src="{% static 'Sudoku/images/profile.jpg' %}" alt="Profile Icon">
                </div>
                <p class="username">{{ username|default:user.username }}</p> </p>
            </div>
            <div class="profile-content">
                <div class="score-display">
                    <p class="score-label">Highest Score</p>
                    <p class="score-value">{{ high_score|default:0 }}</p>
                </div>
                <div class="dropdown-item" onclick="changeUsername()">
                    <img src="{% static 'Sudoku/images/change.png' %}" alt="Edit" width="16" height="16">
                    Change Username
                </div>
                <div class="dropdown-item delete-profile" onclick="deleteProfile()">
                    <img src="{% static 'Sudoku/images/delete.png' %}" alt="Delete" width="16" height="16">
                    Delete Profile
                </div>
                <div class="logout" >
                    <a href="{% url 'logout' %}" class="logout" style="text-decoration: none;">Logout</a>
                </div>
            </div>
        </div>
        {% endif %}   

<div class="sudoku-grid">
    <!-- 81 grid cells for Sudoku -->
    <script>
        const gridContainer = document.querySelector('.sudoku-grid');

// Clear existing content
gridContainer.innerHTML = '';

// Create 81 cells (9x9 grid)
for (let i = 0; i < 81; i++) {
const cell = document.createElement('div');
cell.className = 'cell';
cell.setAttribute('tabindex', '0');
gridContainer.appendChild(cell);
}
   </script>
   </div>
    
    <div>
        <input type="text" placeholder="Enter input" class="user" ></div>

        <div id="rectangle1"></div>

   </div>
   <div class="dialouge">
   <div class="rectangle">

    <div class="rectangle2">
        <img src="{% static 'Sudoku/images/undo.svg' %}" alt="">
       <div class="undo-text">
       <p>Undo</p>
    </div>
    </div>
    
    <div class="rectangle3">
        <img src="{% static 'Sudoku/images/erase.svg' %}" alt="">
        <div class="eraser-text">
            <p>Erase</p>
        </div>
    </div>

    <div class="rectangle4">
        <img src="{% static 'Sudoku/images/clear.svg' %}" alt="">
    <div class="clear-text">
        <p> Clear all</p>
    </div>
    </div>

    <div class="boxes">
        <div class="cell">1</div>
        <div class="cell">2</div>
        <div class="cell">3</div>
        <div class="cell">4</div>
        <div class="cell">5</div>
        <div class="cell">6</div>
        <div class="cell">7</div>
        <div class="cell">8</div>
        <div class="cell">9</div>
    </div>
   
    </div>
    
    <div class="smallrectangle">
        <p id="solve">Solve</p>
      </div>
<script>const hamburger = document.getElementById('ham');  
    const sidebar = document.getElementById('sidebar');  

    hamburger.addEventListener('click', () => {  
        sidebar.classList.toggle('active'); // Toggle the active class  
    });  
    
    document.addEventListener('click', (event) => {  
            const isClickInside = sidebar.contains(event.target) || hamburger.contains(event.target);  
            if (!isClickInside) {  
                sidebar.classList.remove('active'); // Hide the sidebar  
            }  
        });
    
        // Grid functionality
        let selectedCell = null;
        let gameBoard = Array(9).fill().map(() => Array(9).fill(0));
        
        // Initialize the grid
        function initializeGrid() {
            const cells = document.querySelectorAll('.cell');
            cells.forEach((cell, index) => {
                cell.setAttribute('tabindex', '0');
                cell.addEventListener('click', () => selectCell(cell));
                cell.addEventListener('keydown', (e) => handleKeyInput(e, cell));
            });
        }
        
        // Select a cell
        function selectCell(cell) {
            // Remove previous selection
            if (selectedCell) {
                selectedCell.classList.remove('selected');
            }
            
            selectedCell = cell;
            cell.classList.add('selected');
            
            // Highlight related cells
            highlightRelatedCells(cell);
        }
        
        // Handle number input from buttons
        function initializeNumberButtons() {
            for (let i = 1; i <= 9; i++) {
                const button = document.querySelector(`.rectangle${i}`);
                button.addEventListener('click', () => {
                    if (selectedCell) {
                        enterNumber(i);
                    }
                });
            }
        }
        
        // Enter number in selected cell
        function enterNumber(num) {
            if (selectedCell) {
                const row = Math.floor([...selectedCell.parentNode.children].indexOf(selectedCell) / 9);
                const col = [...selectedCell.parentNode.children].indexOf(selectedCell) % 9;
                
                if (isValidMove(row, col, num)) {
                    selectedCell.textContent = num;
                    gameBoard[row][col] = num;
                    
                    // Add animation
                    selectedCell.style.animation = 'numberEnter 0.3s ease';
                    setTimeout(() => {
                        selectedCell.style.animation = '';
                    }, 300);
                } else {
                    // Shake animation for invalid move
                    selectedCell.style.animation = 'invalidMove 0.3s ease';
                    setTimeout(() => {
                        selectedCell.style.animation = '';
                    }, 300);
                }
            }
        }
        
        // Handle keyboard input
        function handleKeyInput(e, cell) {
            const key = e.key;
            if (key >= '1' && key <= '9') {
                selectCell(cell);
                enterNumber(parseInt(key));
            } else if (key === 'Backspace' || key === 'Delete') {
                if (selectedCell) {
                    selectedCell.textContent = '';
                    const row = Math.floor([...cell.parentNode.children].indexOf(cell) / 9);
                    const col = [...cell.parentNode.children].indexOf(cell) % 9;
                    gameBoard[row][col] = 0;
                }
            }
        }
        
        // Highlight related cells
        function highlightRelatedCells(cell) {
            const cells = document.querySelectorAll('.cell');
            cells.forEach(c => c.classList.remove('highlighted'));
            
            const index = [...cell.parentNode.children].indexOf(cell);
            const row = Math.floor(index / 9);
            const col = index % 9;
            const boxStartRow = Math.floor(row / 3) * 3;
            const boxStartCol = Math.floor(col / 3) * 3;
            
            cells.forEach((c, i) => {
                const currentRow = Math.floor(i / 9);
                const currentCol = i % 9;
                
                if (currentRow === row || currentCol === col || 
                    (currentRow >= boxStartRow && currentRow < boxStartRow + 3 &&
                     currentCol >= boxStartCol && currentCol < boxStartCol + 3)) {
                    c.classList.add('highlighted');
                }
            });
        }
        
        // Check if move is valid
        function isValidMove(row, col, num) {
            // Check row
            for (let i = 0; i < 9; i++) {
                if (gameBoard[row][i] === num) return false;
            }
            
            // Check column
            for (let i = 0; i < 9; i++) {
                if (gameBoard[i][col] === num) return false;
            }
            
            // Check 3x3 box
            const boxRow = Math.floor(row / 3) * 3;
            const boxCol = Math.floor(col / 3) * 3;
            for (let i = 0; i < 3; i++) {
                for (let j = 0; j < 3; j++) {
                    if (gameBoard[boxRow + i][boxCol + j] === num) return false;
                }
            }
            
            return true;
        }
        
        // Initialize the game
        document.addEventListener('DOMContentLoaded', () => {
            initializeGrid();
            initializeNumberButtons();
        });
        
        // Add these styles to your CSS
        const styles = document.createElement('style');
        styles.textContent = `
            @keyframes numberEnter {
                0% { transform: scale(1.2); }
                100% { transform: scale(1); }
            }
            
            @keyframes invalidMove {
                0%, 100% { transform: translateX(0); }
                25% { transform: translateX(-5px); }
                75% { transform: translateX(5px); }
            }
        `;
        document.head.appendChild(styles);
        
        // Add this to your existing JavaScript
        document.addEventListener('click', (event) => {
            // Check if the click is outside the grid and number buttons
            const sudokuGrid = document.querySelector('.sudoku-grid');
            const numberButtons = document.querySelector('.buttons');
            
            if (!sudokuGrid.contains(event.target) && !numberButtons.contains(event.target)) {
                // Removse selection and highlights
                if (selectedCell) {
                    selectedCell.classList.remove('selected');
                    selectedCell = null;
                }
                
                // Remove all highlights
                const cells = document.querySelectorAll('.cell');
                cells.forEach(cell => {
                    cell.classList.remove('highlighted');
                });
            }
        });

          
        const userProfile = document.getElementById('userProfile');
        if (userProfile) {
            userProfile.classList.add('authenticated');
            
            userProfile.addEventListener('click', (event) => {
                event.stopPropagation();
                userProfile.classList.toggle('expanded');
            });
    
            document.addEventListener('click', (event) => {
                if (!userProfile.contains(event.target)) {
                    userProfile.classList.remove('expanded');
                }
            });
        }
    
        // Change username function
        function changeUsername() {
        const newUsername = prompt('Enter new username:');
        if (newUsername && newUsername.trim() !== '') {
            fetch('/change-username/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({username: newUsername.trim()})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update username in the UI immediately
                    document.querySelector('.username').textContent = newUsername.trim();
                    // Optional: Show success message
                    alert('Username successfully changed!');
                } else {
                    // Show error message
                    alert(data.error || 'Failed to change username');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while changing username');
            });
        }
    }
    // Helper function to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
        // Delete profile function
        function deleteProfile() {
        if (confirm('Are you sure you want to delete your profile? This action cannot be undone.')) {
            // Get CSRF token
            const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            
            fetch('/delete-profile/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'Content-Type': 'application/json'
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Redirect to home page after successful deletion
                    window.location.href = '/';
                } else {
                    alert('Failed to delete profile. Please try again.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while deleting the profile.');
            });
        }
    }
    </script>

</body>

</html>


